# 実装計画：献立表カレンダー作成ゲーム

## 概要

SPEC.md に基づき、Pygame製の「制約付き配置パズル」ゲームを段階的に実装する。
各フェーズは独立してテスト・動作確認可能な単位とする。

---

## フェーズ 1：プロジェクト基盤 & データモデル

### 1-1. プロジェクトセットアップ
- `requirements.txt` 作成（pygame, ortools）
- ディレクトリ構成作成（`src/`, `src/ui/`, `src/model/`, `assets/`）
- `main.py` エントリポイント（ウィンドウ生成 1280×720、60FPS ループ）
- `assets/config.json` テンプレート作成

### 1-2. 定数・データモデル定義
- `src/constants.py` — 画面サイズ、色、フォントサイズ、メニューID定義
  - メニュー: A=0(からあげ), E=1(エビフライ), U=2(カレーうどん), R=3(カレーライス), C=4(ちらし寿司)
  - カテゴリ: 揚げ物={A, E}
- `src/model/board.py` — 5×5 盤面クラス（配置・削除・リセット・コピー）

**受入基準:** `main.py` 実行でウィンドウ表示、盤面クラスの単体テスト通過

---

## フェーズ 2：画面遷移 & スタート画面

### 2-1. 画面状態管理
- `src/game.py` — GameState enum (START, PLAYING, RESULT) と画面遷移ロジック

### 2-2. UI共通部品
- `src/ui/button.py` — ボタン（矩形+テキスト、ホバー、クリック判定）
- `src/ui/label.py` — テキストラベル（フォント・色・位置）
- アセットマネージャ（`src/asset_manager.py`）— config.json 読込、欠損時プレースホルダ

### 2-3. スタート画面実装
- タイトル表示
- ルール説明（4制約を短く表示）
- スタートボタン → PLAYING へ遷移

**受入基準:** スタート画面表示、ボタン押下でゲーム画面遷移（受入基準 #1 部分達成）

---

## フェーズ 3：ゲーム実行画面（配置操作）

### 3-1. グリッド描画
- `src/ui/grid.py` — 5×5 グリッド描画（行=日、列=ブロック、ヘッダラベル付き）

### 3-2. メニューパレット
- `src/ui/palette.py` — 左側メニュー5種の表示（アイコン+名称、揚げ物バッジ）
- アイコン: PNG があれば表示、なければ色付き矩形+テキストで代替

### 3-3. ドラッグ＆ドロップ
- `src/ui/drag_drop.py` — D&D マネージャ
  - パレット → セルへドロップ（配置）
  - セル → セルへドラッグ（移動）
  - 右クリック or Delete でセル消去
  - セル上書き可

### 3-4. タイマー
- `src/ui/timer.py` — 180秒カウントダウン、0秒で操作ロック→RESULT遷移

### 3-5. ボタン群
- 完了ボタン（即座にRESULTへ）
- リセットボタン（盤面のみ初期化、タイマー継続）
- 戻るボタン（STARTへ）

**受入基準:** D&D配置/移動/削除動作、タイマー動作（受入基準 #2, #3）

---

## フェーズ 4：制約チェック & 採点

### 4-1. 違反検出
- `src/model/rules.py`
  1. ブロック内重複（列ごと）→ 重複セル座標リスト
  2. ちらし寿司同日上限（行ごと）→ 超過セル座標リスト
  3. 揚げ物カテゴリ上限（行ごと）→ 超過セル座標リスト（左から3つ許容、4つ目以降）
  4. カレー連続禁止（列ごと隣接ペア）→ 違反ペア座標リスト
- 各関数は `List[Violation]` を返す（種別, セル座標, 件数）

### 4-2. 採点ロジック
- `src/model/scoring.py`
  - 空欄: -3点/マス
  - ブロック内重複: -8点/件
  - ちらし寿司超過: -10点/件
  - 揚げ物超過: -6点/件
  - カレー連続: -10点/件
  - 早解きボーナス: 残120秒以上 +5, 残60秒以上 +3
  - `score = min(100, max(0, 100 - penalty + bonus))`
  - 講評コメント生成（点数帯別）

### 4-3. リアルタイム警告（ゲーム中）
- 配置直後に違反検出 → 該当セル点滅 + 警告音

**受入基準:** 採点結果が仕様通り（受入基準 #4）、単体テスト

---

## フェーズ 5：CP-SAT 解答生成

### 5-1. OR-Tools ソルバー
- `src/model/solver.py`
  - 変数: `x[d][b] ∈ {0..4}`
  - 制約1: 列ごと AllDifferent
  - 制約2: 行ごと ちらし寿司 ≤ 1
  - 制約3: 行ごと 揚げ物 ≤ 3
  - 制約4: 列ごと隣接カレー連続禁止
  - 1解取得、タイムアウト付き
  - 失敗時フォールバック: ハードコード固定解

### 5-2. ゲーム開始時に非同期生成
- PLAYING 遷移時に解を生成しキャッシュ

**受入基準:** 生成された解が全制約を満たす（受入基準 #6）、単体テスト

---

## フェーズ 6：結果確認画面

### 6-1. レイアウト
- 上: 点数（大きいフォント）+ 講評コメント
- 左: プレイヤー盤面
  - 違反ハイライト（空欄=薄グレー+「？」、重複=赤枠、ちらし寿司=青枠、揚げ物=オレンジ枠、カレー連続=紫枠）
  - 違反一覧パネル（種別×件数＋位置）
- 右: システム解答（CP-SAT結果表示）
- 下: 終了ボタン → START へ

**受入基準:** 違反ハイライト表示（受入基準 #5）、画面遷移完成（受入基準 #1 完了）

---

## フェーズ 7：効果音 & アセット仕上げ

### 7-1. 効果音
- ボタン押下音
- つかむ音
- ドロップ成功音
- 警告音（違反発生時）
- WAV/OGG、`assets/sounds/` に配置、config.json で参照
- 音声初期化失敗時は無音で継続

### 7-2. アイコン・フォント
- メニューアイコン PNG を `assets/icons/` に配置
- 日本語フォントを `assets/fonts/` に配置
- 欠損時はプレースホルダ描画

### 7-3. デザイン調整
- 小学生向けポップなカラースキーム
- 大きめフォント、色のコントラスト確保
- Figma MCP またはAPI連携でデザイン確認
  - デザインの詳細はDESIGN.mdを必ず参照すること

**受入基準:** アセット差し替えで動作継続（受入基準 #7）

---

## フェーズ 8：統合テスト & バグ修正

- 全画面遷移の通しプレイテスト
- エッジケース確認（全空欄で完了、全マス同じメニュー、タイムアウト遷移）
- 例外で落ちないことの確認（アセット欠損、音声初期化失敗）
- パフォーマンス確認（60FPS 維持）

---

## 依存関係

```
Phase 1 → Phase 2 → Phase 3 → Phase 4 → Phase 6
                                  ↓
Phase 1 ──────────────────→ Phase 5 → Phase 6
                                         ↓
                               Phase 7 → Phase 8
```

## GitHub Issue 対応案

| Issue # | タイトル | 対応フェーズ |
|---------|---------|-------------|
| #1 | プロジェクト基盤 & データモデル | Phase 1 |
| #2 | 画面遷移 & スタート画面 | Phase 2 |
| #3 | ゲーム実行画面（D&D・タイマー） | Phase 3 |
| #4 | 制約チェック & 採点ロジック | Phase 4 |
| #5 | CP-SAT 解答生成 | Phase 5 |
| #6 | 結果確認画面 | Phase 6 |
| #7 | 効果音 & アセット仕上げ | Phase 7 |
| #8 | 統合テスト & バグ修正 | Phase 8 |
