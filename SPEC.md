# 要件定義書：献立表カレンダー作成ゲーム（Pygame）

## 1. 目的・背景

学校給食DXの実証で扱う「献立表カレンダー作成ツール」をモチーフに、**制約付き配置パズル**として遊べるゲームを提供する。
プレイヤーは制限時間内に、献立を5日×5ブロックへ配置し、制約を満たす献立表を完成させる。

## 2. スコープ

### 2.1 対象範囲（本ゲームに含む）

* 3画面（スタート／ゲーム実行／結果確認）
* ドラッグ＆ドロップによる献立配置
* 制約チェック、採点（100点満点）、講評コメント表示
* システム解答（CP-SAT）生成と表示
* 画像・効果音アセット差し替え

### 2.2 対象外（将来拡張候補）

* ステージ制（難易度切替・複数ルールセット）
* オンラインランキング
* セーブ／ロード
* 多言語対応

## 3. 利用技術

* Python 3.x
* Pygame
* OR-Tools（CP-SAT）

  * ルール変更に備えた**解答作成エンジン**として採用。

## 4. ゲームルール（固定）

### 4.1 グリッド定義

* 5日（行）×5ブロック（列）＝25マス
* 各マスに「献立メニュー」1つを配置

### 4.2 献立メニュー（固定5種）

* からあげ（揚げ物）
* エビフライ（揚げ物）
* カレーうどん
* カレーライス
* ちらし寿司

### 4.3 制約（必須）

1. **ブロック内重複禁止（同一列）**

* 同じブロック（列）内に同じメニューは1回しか置けない。

2. **ちらし寿司は同じ日に1ブロックまで（同一行）**

* 同じ日（行）で「ちらし寿司」は最大1つ。

3. **揚げ物カテゴリ上限（同一行）**

* 同じ日（行）で、揚げ物（からあげ・エビフライ）の合計は **最大3つ**。

4. **カレー2種の連続禁止（同一列）**

* 同じブロック（列）において、連続する2日で

  * (カレーうどん→カレーライス) と (カレーライス→カレーうどん) を禁止。

> 注：上記は“採点用の制約”であり、ゲーム中の配置自体は原則許可（警告表示＋減点）とする。

---

## 5. 画面要件

## 5.1 スタート画面

* タイトル
* ルール説明（4つの制約を短く）
* スタートボタン → ゲーム実行へ

## 5.2 ゲーム実行画面

### レイアウト

* 上：制限時間カウントダウン（3:00）
* 左：メニュー5種（アイコン＋名称、揚げ物は「揚げ物」バッジ表示）
* 右：5×5グリッド
* 下：完了／リセット／戻る

### 操作

* 左のメニューをドラッグしてセルにドロップ
* セル上書き可
* セル→セルへの移動可（ドラッグ）
* 右クリック（またはDelete）でセルを空にする

### タイマー

* 180秒
* 0秒で操作ロック→結果確認画面へ（未配置ありでも採点）

### リセット仕様

* 盤面のみ初期化（タイマーは継続）※確定

### 効果音（差し替え可能）

* ボタン押下
* つかむ
* ドロップ成功
* 警告（違反発生）

## 5.3 結果確認画面

* 上：点数（100点満点）＋講評コメント
* 左：プレイヤー盤面（違反ハイライト＋違反一覧）
* 右：システム解答（CP-SATで生成）
* 下：終了ボタン→スタートへ

---

## 6. 採点・チェック仕様（検討事項の具体化）

## 6.1 採点方針

* **25マス埋まっていて、全制約を満たす** → 100点
* 空欄・制約違反は減点（下限0点）
* **日単位違反のペナルティを重め**に設定する

## 6.2 減点ロジック（確定仕様）

`score = min(100, max(0, 100 - penalty + bonus))`

### A) 未配置マス

* 空欄1マス：**-3点**

### B) 制約違反（件数カウント）

違反件数は「最小単位の衝突」を1件として数える。

1. ブロック内重複（列）

* ある列でメニューが `k` 回出現 → 違反 `k-1`
* 1件：**-8点**

2. ちらし寿司 同日上限（行）

* ある行でちらし寿司が `k` 個 → 超過 `max(0, k-1)`
* 1件：**-10点**

3. 揚げ物カテゴリ 同日上限（行）

* ある行で揚げ物（からあげ・エビフライ）の合計が `f` 個 → 超過 `max(0, f-3)`
* 1件：**-6点**

  * ※3まではOKなので、超過は4個目・5個目に対して発生

4. カレー2種 連続禁止（列）

* 隣接ペアで (U,R) または (R,U) が出現 → 1件
* 1件：**-10点**

### C) 早解きボーナス（採用）

* 完了ボタンで確定した場合のみ

  * 残り120秒以上：+5（上限100）
  * 残り60秒以上：+3（上限100）

## 6.3 誤りの視覚指摘（具体仕様）

### ハイライト規則（結果画面）

* 空欄：薄グレー背景＋「？」表示
* ブロック内重複：赤枠（重複セルすべて）
* ちらし寿司上限超過：青枠（超過セルのみ）
* 揚げ物上限超過：オレンジ枠（その行の揚げ物セルのうち“超過分”）

  * 超過分の選び方：左から順に3つを許容、4つ目以降を超過扱い（実装簡便のため確定）
* カレー連続：紫枠（隣接ペアの2セル）

### 違反一覧パネル（結果画面）

* 違反種別 × 件数
* 可能なら位置も表示

  * 例：`カレー連続: (2ブロック 3日-4日)`

### ゲーム中のリアルタイム警告（採用）

* 配置直後に違反が増えた場合、該当セルを短く点滅＋警告音
* **配置は拒否しない**（置けるが減点）

---

## 7. CP-SAT 解答生成（OR-Tools）

### 7.1 目的

* 結果画面で模範解答を表示
* ルール変更時の柔軟性確保

### 7.2 変数

* `x[d][b] ∈ {0..4}`（日d=0..4、ブロックb=0..4）
* メニューID例：A=0, E=1, U=2, R=3, C=4（固定）

### 7.3 制約

1. 列ごとにAllDifferent

* `AllDifferent(x[0][b],...,x[4][b])`

2. 行ごとに「ちらし寿司 ≤ 1」

* `sum(x[d][b]==C for b) ≤ 1`

3. 行ごとに「揚げ物 ≤ 3」

* `sum(x[d][b] in {A,E} for b) ≤ 3`

4. 列ごとの隣接ペア禁止

* 各列b、各d=0..3

  * `(x[d][b]==U ∧ x[d+1][b]==R) 禁止`
  * `(x[d][b]==R ∧ x[d+1][b]==U) 禁止`

### 7.4 解の取得

* 1解で良い（ゲーム開始時に生成してキャッシュ）
* 失敗時フォールバック：同梱固定解を表示（保険）

---

## 8. デザイン・音声要件

* Figma Design とMCP連携して以下のデザインを実現する。
 
  * 小学生向け：ポップ／かわいい／視認性重視（大きめフォント、色のコントラスト）
  * メニューアイコン差し替え可能（PNG透過推奨）
  * 効果音差し替え可能（WAV/OGG）

### アセット管理方式（確定）

* `assets/config.json` にパス定義
* 欠損時はプレースホルダ描画で起動継続

---

## 9. 非機能要件

* Windows優先で動作
* 画面サイズ固定（例：1280×720）
* 60FPS目標
* 例外で落ちない（アセット欠損、音声初期化失敗など）

---

## 10. ディレクトリ構成（案）

* `main.py`
* `src/`

  * `game.py`（画面状態遷移）
  * `ui/`（ボタン、ラベル、グリッド、D&D）
  * `model/`

    * `rules.py`（違反検出：空欄/重複/日制約/連続）
    * `scoring.py`（減点＋ボーナス＋内訳）
    * `solver.py`（OR-Toolsモデル）
* `assets/`

  * `config.json`
  * `icons/`
  * `sounds/`
  * `fonts/`

---

## 11. 受入基準

1. 3画面の遷移ができる
2. 3分タイマーが動作し、0秒で結果へ遷移
3. D&Dで配置／移動／削除ができる
4. 結果画面で点数と減点内訳が整合する
5. 4制約に対する違反セルがハイライトされる
6. CP-SATの模範解答が表示され、制約を満たしている
7. アセット差し替えで動作が継続する